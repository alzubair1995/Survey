{% extends "base.html" %}
{% block title %}لوحة الأدمن{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
  <div>
    <h2 class="text-2xl font-extrabold">
      <i class="fa-solid fa-gauge-high ml-2 text-indigo-600"></i> لوحة الأدمن
    </h2>
    <p class="text-sm text-slate-500">إحصائيات متقدمة + جارتات + تصدير Excel</p>
  </div>

  <div class="flex gap-2">
    <a href="{{ url_for('auth.logout') }}"
       class="px-4 py-2 rounded-2xl bg-red-600 text-white hover:bg-red-700 transition shadow">
      <i class="fa-solid fa-right-from-bracket ml-1"></i> خروج
    </a>
  </div>
</div>

<!-- KPIs -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <div class="glass border border-white/70 rounded-3xl p-4 shadow">
    <div class="text-slate-500 text-sm">إجمالي المشاركات</div>
    <div class="text-3xl font-extrabold mt-1">{{ total }}</div>
    <div class="text-xs text-slate-500 mt-2"><i class="fa-solid fa-wave-square ml-1"></i> مؤشر عام</div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-4 shadow">
    <div class="text-slate-500 text-sm">أكثر جهاز استخدامًا</div>
    <div class="text-lg font-extrabold mt-1">
      {% if kpis.top_device and kpis.top_device[0] %} {{ kpis.top_device[0][0] }} {% else %} — {% endif %}
    </div>
    <div class="text-xs text-slate-500 mt-2">
      {% if kpis.top_device and kpis.top_device[0] %} {{ kpis.top_device[0][1] }} مشاركة {% endif %}
    </div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-4 shadow">
    <div class="text-slate-500 text-sm">أكثر مرحلة مشاركة</div>
    <div class="text-lg font-extrabold mt-1">
      {% if kpis.top_stage and kpis.top_stage[0] %} {{ kpis.top_stage[0][0] }} {% else %} — {% endif %}
    </div>
    <div class="text-xs text-slate-500 mt-2">
      {% if kpis.top_stage and kpis.top_stage[0] %} {{ kpis.top_stage[0][1] }} مشاركة {% endif %}
    </div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-4 shadow">
    <div class="text-slate-500 text-sm">تفضيل الدراسة الأعلى</div>
    <div class="text-lg font-extrabold mt-1">
      {% if kpis.top_preference and kpis.top_preference[0] %} {{ kpis.top_preference[0][0] }} {% else %} — {% endif %}
    </div>
    <div class="text-xs text-slate-500 mt-2">
      {% if kpis.top_preference and kpis.top_preference[0] %} {{ kpis.top_preference[0][1] }} مشاركة {% endif %}
    </div>
  </div>
</div>

<!-- Export -->
<div class="glass border border-white/70 rounded-3xl p-5 shadow mb-6">
  <div class="font-extrabold mb-3">
    <i class="fa-solid fa-file-excel ml-2 text-emerald-600"></i> تصدير Excel بين تاريخين
  </div>
  <form method="GET" action="{{ url_for('admin.export_excel') }}" class="flex flex-col md:flex-row gap-2 items-center">
    <input type="date" name="from" required class="border border-slate-200 bg-white/70 p-2 rounded-2xl w-full md:w-auto">
    <input type="date" name="to" required class="border border-slate-200 bg-white/70 p-2 rounded-2xl w-full md:w-auto">
    <button class="px-4 py-2 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 transition shadow font-bold w-full md:w-auto">
      <i class="fa-solid fa-download ml-1"></i> تنزيل Excel
    </button>

    <button formaction="{{ url_for('admin.export_pdf') }}" formmethod="get"
        class="px-4 py-2 rounded-2xl bg-indigo-600 text-white hover:bg-indigo-700 transition shadow font-bold w-full md:w-auto">
  <i class="fa-solid fa-file-pdf ml-1"></i> تقرير PDF
</button>

  </form>
</div>

<!-- Trend -->
<div class="glass border border-white/70 rounded-3xl p-5 shadow mb-6">
  <div class="font-extrabold mb-3">
    <i class="fa-solid fa-chart-line ml-2 text-indigo-600"></i> عدد المشاركات (آخر 7 أيام)
  </div>
  <div class="bg-white/60 border border-white/70 rounded-2xl p-3">
    <canvas id="trendChart" height="120"></canvas>
  </div>
</div>

<!-- Charts grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-chart-pie ml-2 text-indigo-600"></i> الجنس</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="genderChart" height="140"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-chart-column ml-2 text-blue-700"></i> المرحلة الدراسية</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="stageChart" height="140"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-face-smile ml-2 text-emerald-700"></i> الرضا عن التعلم الإلكتروني</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="satChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-brain ml-2 text-slate-700"></i> هل يساعد على فهم المادة؟</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="underChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-mobile-screen-button ml-2 text-indigo-600"></i> الجهاز المستخدم</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="deviceChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-wifi ml-2 text-blue-700"></i> جودة الإنترنت</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="internetChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-graduation-cap ml-2 text-emerald-700"></i> سهولة المنصة</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="platformChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-chalkboard-user ml-2 text-slate-700"></i> التفاعل مع المدرس</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="interactionChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-people-arrows ml-2 text-indigo-600"></i> تفضيل طريقة الدراسة</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="prefChart" height="160"></canvas></div>
  </div>

  <div class="glass border border-white/70 rounded-3xl p-5 shadow">
    <div class="font-extrabold mb-3"><i class="fa-solid fa-rotate ml-2 text-slate-700"></i> الاستمرار بالتعلم الإلكتروني</div>
    <div class="bg-white/60 border border-white/70 rounded-2xl p-3"><canvas id="contChart" height="160"></canvas></div>
  </div>
</div>

<!-- Latest -->
<div class="glass border border-white/70 rounded-3xl p-5 shadow">
  <div class="font-extrabold mb-3"><i class="fa-solid fa-clock-rotate-left ml-2"></i> آخر المشاركات</div>
  <div class="space-y-2">
    {% for r in latest %}
      <div class="bg-white/70 border border-white/70 rounded-2xl p-3">
        <div class="font-extrabold">#{{ r.id }} • مشاركة جديدة</div>
        <div class="text-sm text-slate-600">
          الجنس: {{ r.gender }} | المرحلة: {{ r.education_stage }} | التفضيل: {{ r.study_preference }}
        </div>
        <div class="text-xs text-slate-500">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
      </div>
    {% endfor %}
    {% if not latest %}
      <div class="text-slate-500">لا توجد مشاركات بعد.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function safeDict(d){ return d && Object.keys(d).length ? d : {"لا توجد بيانات": 0}; }

  function chartFromDict(canvasId, dictObj, type="bar", legend=true) {
    dictObj = safeDict(dictObj);
    const labels = Object.keys(dictObj);
    const values = Object.values(dictObj);

    const ctx = document.getElementById(canvasId);
    new Chart(ctx, {
      type,
      data: { labels, datasets: [{ data: values }] },
      options: {
        responsive: true,
        plugins: { legend: { display: legend, position: "bottom" } },
        scales: (type === "bar" || type === "line") ? { y: { beginAtZero: true } } : {}
      }
    });
  }

  // Trend (last 7 days)
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: {{ trend_labels|tojson }},
      datasets: [{ data: {{ trend_values|tojson }} }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });

  chartFromDict("genderChart", {{ gender_counts|tojson }}, "pie");
  chartFromDict("stageChart", {{ stage_counts|tojson }}, "bar", false);
  chartFromDict("satChart", {{ satisfaction_counts|tojson }}, "bar", false);
  chartFromDict("underChart", {{ understanding_counts|tojson }}, "bar", false);

  chartFromDict("deviceChart", {{ device_counts|tojson }}, "bar", false);
  chartFromDict("internetChart", {{ internet_counts|tojson }}, "bar", false);
  chartFromDict("platformChart", {{ platform_counts|tojson }}, "bar", false);
  chartFromDict("interactionChart", {{ interaction_counts|tojson }}, "bar", false);

  chartFromDict("prefChart", {{ preference_counts|tojson }}, "pie");
  chartFromDict("contChart", {{ continue_counts|tojson }}, "doughnut");
</script>
{% endblock %}
